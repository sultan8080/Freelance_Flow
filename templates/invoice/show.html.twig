{% extends 'dashboard/base.html.twig' %}

{% block title %}
	{{ 'Invoice #'|trans }}{{ invoice.invoiceNumber }}
{% endblock %}

{% block dashboard_content %}
	<div
		class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

		{# --- 1. Actions Header --- #}

		<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">

			<a href="{{ path('app_invoice_index') }}" class="text-slate-400 font-bold block hover:text-primary">
				<i class="fas fa-arrow-left mr-2"></i>
				{{ 'Back to list'|trans }}
			</a>
			<div class="flex gap-4 w-full md:w-auto">
				{% if invoice.status == 'DRAFT' %}
					<a href="{{ path('app_invoice_edit', {id: invoice.id}) }}" class="group relative flex-1 md:flex-none justify-center inline-flex items-center px-6 py-3 rounded-xl overflow-hidden shadow-xl shadow-blue-500/20 transition-all hover:scale-[1.02]">
						<div class="absolute inset-0 w-full h-full bg-gradient-to-r from-blue-600 to-purple-700 opacity-90 group-hover:opacity-100 transition-opacity"></div>
						<div class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:animate-shimmer"></div>
						<span class="relative flex items-center gap-2 text-sm font-bold text-white tracking-wide">
							<i class="fas fa-pen text-xs"></i>
							{{ 'Edit Invoice'|trans }}
						</span>
					</a>
				{% else %}
					<a href="{{ path('app_invoice_export_pdf', {id: invoice.id}) }}" target="_blank" class="flex-1 md:flex-none justify-center inline-flex items-center bg-gradient-to-r from-blue-600 to-purple-700 text-slate-300 border border-white/10 px-6 py-3 rounded-lg text-sm font-semibold hover:bg-white/[0.08] hover:text-white transition-all backdrop-blur-md hover:border-white/20 shadow-lg">
						<i class="fas fa-file-pdf mr-2 text-red-400"></i>
						{{ 'Download PDF'|trans }}
					</a>
				{% endif %}
			</div>
		</div>

		{# --- 2. Invoice Card --- #}

		<div
			class="relative w-full rounded-3xl border border-slate-800 bg-slate-900/50 backdrop-blur-xl shadow-2xl overflow-hidden print:shadow-none print:border-none print:bg-white print:p-0 print:overflow-visible">
			<div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl -z-10 pointer-events-none print:hidden"></div>
			<div class="absolute bottom-0 left-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -z-10 pointer-events-none print:hidden"></div>

			<div
				class="p-8 md:p-12 print:p-0">

				{# --- Header Section --- #}
				<div
					class="flex flex-col md:flex-row justify-between items-start border-b border-slate-800/50 pb-8 mb-8 gap-8 print:border-gray-200">

					{# Left: Title & Status #}
					<div class="space-y-4">
						<div class="flex items-center gap-4">
							<h1 class="text-3xl md:text-4xl font-black text-white tracking-tight print:text-black">
								{{ 'INVOICE'|trans }}
							</h1>

							{# Dynamic Status Badge #}
							{% set badgeColors = {
                                'SENT': 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                                'PAID': 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
                                'UNPAID': 'bg-amber-500/10 text-amber-400 border-amber-500/20',
                                'DRAFT': 'bg-slate-500/10 text-slate-400 border-slate-500/20'
                            } %}
							{% set currentBadge = badgeColors[invoice.status] ?? badgeColors['DRAFT'] %}

							<span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border {{ currentBadge }} print:border-black print:text-black print:bg-transparent">
								{{ invoice.status|trans }}
							</span>
						</div>

						{% if invoice.projectTitle %}
							<div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50 border border-slate-700/50 text-slate-300 text-sm font-medium print:bg-gray-100 print:border-gray-200 print:text-black">
								<i class="fas fa-folder-open text-blue-400/80"></i>
								{{ invoice.projectTitle }}
							</div>
						{% endif %}
					</div>

					{# Right: Metadata Grid #}
					<div class="w-full md:w-auto bg-slate-800/30 rounded-2xl p-5 border border-slate-700/30 print:bg-transparent print:border-none print:p-0">
						<div class="grid grid-cols-3 md:flex md:gap-8 divide-x divide-slate-700/50 print:divide-none">
							<div class="px-4 first:pl-0 md:text-right">
								<p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">{{ 'Invoice No'|trans }}</p>
								<p class="text-white font-mono font-bold text-lg print:text-black">#{{ invoice.invoiceNumber|default('DRAFT'|trans) }}</p>
							</div>
							<div class="px-4 md:text-right">
								<p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">{{ 'Issue Date'|trans }}</p>
								<p class="text-slate-200 font-medium print:text-black">{{ invoice.sentAt ? invoice.sentAt|date('d M Y') : 'Draft'|trans }}</p>
							</div>
							<div class="px-4 last:pr-0 md:text-right">
								<p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">{{ 'Due Date'|trans }}</p>
								<p class="font-bold {{ invoice.isOverdue ? 'text-red-400' : 'text-white' }} print:text-black">
									{{ invoice.dueDate ? invoice.dueDate|date('d M Y') : '-' }}
								</p>
							</div>
						</div>
					</div>
				</div>

				{# --- Addresses Section --- #}
				<div
					class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
					{# From #}
					<div>
						<h3 class="flex items-center text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">
							<span class="w-1.5 h-1.5 rounded-full bg-blue-500 mr-2"></span>
							{{ 'From'|trans }}
						</h3>
						<div class="pl-4 border-l-2 border-slate-800 print:border-gray-300">
							<div class="text-white font-bold text-lg print:text-black">
								{{ app.user.companyName|default(app.user.firstName ~ ' ' ~ app.user.lastName) }}
							</div>
							{% if app.user.companyName is defined and app.user.companyName %}
								<div class="text-slate-400 text-sm mb-2 print:text-black">{{ app.user.firstName }}
									{{ app.user.lastName }}</div>
							{% endif %}

							<div class="text-slate-400 text-sm whitespace-pre-line font-light leading-relaxed print:text-black">
								{{ app.user.address|default('No address defined'|trans) }}
								{{ app.user.postCode|default('') }}
								{{ app.user.city|default('') }}
								{{ app.user.country|default('') }}
							</div>
							<div class="text-slate-500 text-sm mt-1 print:text-black">{{ app.user.email }}</div>

							{# Legal Info #}
							<div class="mt-4 pt-3 border-t border-dashed border-slate-800 print:border-gray-300">
								<div class="text-[10px] text-slate-500 font-mono">
									SIRET:
									<span class="text-slate-300 print:text-black">{{ app.user.siret|default('---') }}</span>
									<span class="mx-2 text-slate-700">|</span>
									VAT:
									<span class="text-slate-300 print:text-black">{{ app.user.vatNumber|default('N/A') }}</span>
								</div>
							</div>
						</div>
					</div>

					{# Bill To #}
					<div class="md:text-right">
						<h3 class="flex items-center md:justify-end text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">
							{{ 'Bill To'|trans }}
							<span class="w-1.5 h-1.5 rounded-full bg-purple-500 ml-2"></span>
						</h3>

						{% set clientName = invoice.frozenClientName ?: (invoice.client ? invoice.client.fullName : 'No Client Selected'|trans) %}
						{% set clientCompany = invoice.frozenClientCompanyName ?: (invoice.client ? invoice.client.companyName : '') %}
						{% set clientAddress = invoice.frozenClientAddress ?: (invoice.client ? invoice.client.address ~ ', ' ~ invoice.client.city : '') %}

						<div class="pr-4 border-r-2 border-slate-800 md:pl-0 md:border-l-0 border-l-2 pl-4 md:border-r-2 print:border-gray-300">
							<div class="text-white font-bold text-lg print:text-black">{{ clientName }}</div>
							{% if clientCompany %}
								<div class="text-slate-400 text-sm mb-2 print:text-black">{{ clientCompany }}</div>
							{% endif %}

							{% if clientAddress %}
								<div class="text-slate-400 text-sm whitespace-pre-line font-light leading-relaxed print:text-black">{{ clientAddress }}</div>
							{% else %}
								<div class="text-red-400/80 text-xs italic mt-1">{{ 'No address provided'|trans }}</div>
							{% endif %}
						</div>
					</div>
				</div>

				{# --- Items Table --- #}
				<div class="rounded-xl border border-slate-800 overflow-hidden mb-8 print:border-gray-300">
					<table class="w-full text-left">
						<thead class="bg-slate-900/50 border-b border-slate-800 print:bg-gray-100 print:border-gray-300">
							<tr>
								<th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider print:text-black">{{ 'Description'|trans }}</th>
								<th class="px-6 py-4 text-right text-xs font-bold text-slate-400 uppercase tracking-wider print:text-black">{{ 'Qty'|trans }}</th>
								<th class="px-6 py-4 text-right text-xs font-bold text-slate-400 uppercase tracking-wider print:text-black">{{ 'Price'|trans }}</th>
								<th class="px-6 py-4 text-right text-xs font-bold text-slate-400 uppercase tracking-wider print:text-black">{{ 'Total'|trans }}</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-slate-800 text-sm print:divide-gray-200">
							{% for item in invoice.invoiceItems %}
								<tr class="group hover:bg-slate-800/30 transition-colors">
									<td class="px-6 py-4 font-medium text-slate-200 print:text-black">{{ item.description }}</td>
									<td class="px-6 py-4 text-right text-slate-400 font-mono print:text-black">{{ item.quantity }}</td>
									<td class="px-6 py-4 text-right text-slate-400 font-mono print:text-black">{{ item.unitPrice|number_format(2) }}</td>
									<td class="px-6 py-4 text-right font-bold text-white font-mono print:text-black">{{ item.totalHt|number_format(2) }}</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="4" class="px-6 py-8 text-center text-slate-500 italic">
										{{ 'No items added to this invoice.'|trans }}
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{# --- Totals & Insights --- #}
				<div
					class="flex flex-col md:flex-row justify-end gap-8 items-start">

					{# PRIVATE INSIGHTS (Hidden on Print) #}
					<div class="w-full md:w-auto order-2 md:order-1 mt-4 md:mt-0 print:hidden">
						<div class="rounded-xl bg-amber-500/5 border border-amber-500/10 p-5 backdrop-blur-sm">
							<div class="flex items-center gap-3 mb-4">
								<div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-500">
									<i class="fas fa-eye-slash text-xs"></i>
								</div>
								<div class="flex flex-col">
									<h4 class="text-amber-200 font-bold text-xs uppercase tracking-widest mb-1">
										{{ 'Private Insight'|trans }}
									</h4>

									<p class="text-amber-500/80 text-[11px] font-medium leading-tight">
										{{ 'Net earnings estimate'|trans }}
									</p>

									<p class="text-amber-500/50 text-[10px] italic leading-tight mt-0.5">
										<i class="fas fa-info-circle mr-1"></i>
										{{ 'Not included in PDF'|trans }}
									</p>
								</div>

							</div>
							<div class="flex items-center gap-6 border-t border-amber-500/10 pt-3">
								<div class="text-right">
									<div class="text-[10px] uppercase text-amber-500/50 font-bold">{{ 'Est. URSSAF'|trans }}</div>
									<div class="text-red-400 font-mono font-bold">{{ invoice.urssafEstimate|number_format(2) }}€</div>
								</div>
								<div class="text-right pl-6 border-l border-amber-500/10">
									<div class="text-[10px] uppercase text-amber-500/50 font-bold">{{ 'Net Income'|trans }}</div>
									<div class="text-emerald-400 font-mono font-bold text-lg">{{ invoice.netEstimate|number_format(2) }}€</div>
								</div>
							</div>
						</div>
					</div>

					{# PUBLIC TOTALS #}
					<div class="w-full md:w-1/3 order-1 md:order-2 space-y-3">
						<div class="flex justify-between items-center text-sm">
							<span class="text-slate-400 font-medium print:text-black">{{ 'Subtotal (HT)'|trans }}</span>
							<span class="font-mono text-slate-200 font-bold print:text-black">{{ invoice.totalHt|number_format(2) }}
								{{ invoice.currency }}</span>
						</div>
						<div class="flex justify-between items-center text-sm">
							<span class="text-slate-400 font-medium print:text-black">{{ 'VAT Amount'|trans }}</span>
							<span class="font-mono text-slate-200 font-bold print:text-black">{{ invoice.totalVat|number_format(2) }}
								{{ invoice.currency }}</span>
						</div>

						<div class="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center print:border-gray-300">
							<span class="text-white font-bold text-lg print:text-black">{{ 'Total Amount'|trans }}</span>
							<div class="text-right">
								<span class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 font-mono tracking-tight print:text-black print:bg-none">
									{{ invoice.totalAmount|number_format(2) }}
								</span>
								<span class="text-sm text-slate-500 font-bold ml-1 print:text-black">{{ invoice.currency }}</span>
							</div>
						</div>

						{% if invoice.totalVat == 0 %}
							<div class="text-right text-xs text-slate-500 italic mt-2">
								{{ 'TVA non applicable, art. 293 B du CGI' }}
							</div>
						{% endif %}
					</div>
				</div>

				{# --- Paid Stamp --- #}
				{% if invoice.paidAt %}
					<div class="mt-12 p-4 bg-emerald-500/5 border border-emerald-500/10 rounded-xl flex items-center justify-center gap-3 print:hidden">
						<div class="w-8 h-8 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-400">
							<i class="fas fa-check text-xs"></i>
						</div>
						<p class="text-emerald-300 text-sm font-medium">
							{{ 'This invoice was fully paid on %date%'|trans({'%date%': '<span class="text-white font-bold">' ~ invoice.paidAt|date('d F Y') ~ '</span>'})|raw }}
						</p>
					</div>
				{% endif %}

			</div>
		</div>
	</div>
{% endblock %}
